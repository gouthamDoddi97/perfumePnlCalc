<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Perfume P&L Calculator - Dubai to India Import (2025)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.6s ease-out;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            color: #764ba2;
            margin: 20px 0 15px 0;
            font-size: 1.2em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .label-info {
            font-size: 0.85em;
            color: #666;
            font-weight: 400;
            margin-left: 5px;
        }

        input,
        select,
        textarea {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .oil-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.4s ease-out;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .preview-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .preview-table tr:hover {
            background: #f9fafb;
        }

        .profit-positive {
            color: #059669;
            font-weight: 600;
        }

        .profit-negative {
            color: #dc2626;
            font-weight: 600;
        }

        .profit-neutral {
            color: #f59e0b;
            font-weight: 600;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            margin-top: 15px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .icon {
            font-size: 1.2em;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .oil-input-row {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ Perfume P&L Calculator</h1>
            <p>Dubai to India Import - 2025 Compliant</p>
        </div>

        <div class="alert alert-warning">
            <span class="icon">‚ö†Ô∏è</span>
            <div>
                <strong>2025 Update:</strong> Calculations now include Social Welfare Surcharge (SWS) - 10% of Basic
                Customs Duty, as per current India import regulations.
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üí±</span> Exchange Rate & Duties</h2>

            <div class="grid">
                <div class="form-group">
                    <label>AED ‚Üí INR Exchange Rate</label>
                    <input type="number" id="rate" value="24" step="0.1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Dubai VAT <span class="label-info">(on oil purchase)</span></label>
                    <input type="number" id="vat" value="5" step="0.1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Basic Customs Duty (BCD) <span class="label-info">(%)</span></label>
                    <input type="number" id="customs" value="20" step="0.1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Social Welfare Surcharge <span class="label-info">(% of BCD)</span></label>
                    <input type="number" id="sws" value="10" step="0.1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>GST <span class="label-info">(%)</span></label>
                    <input type="number" id="gst" value="18" step="0.1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Apply BCD on Shipping? (CIF)</label>
                    <select id="cif" onchange="updatePreview()">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üì¶</span> Per-Unit Costs (INR)</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">All costs are per 50ml bottle</p>

            <div class="grid">
                <div class="form-group">
                    <label>Bottle (‚Çπ)</label>
                    <input type="number" id="bottle" value="70" step="1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Labels & Caps (‚Çπ)</label>
                    <input type="number" id="labels" value="10" step="1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Packaging (‚Çπ)</label>
                    <input type="number" id="pack" value="20" step="1" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Shipping per Unit (‚Çπ)</label>
                    <input type="number" id="ship" value="30" step="1" oninput="updatePreview()">
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üí∞</span> Pricing</h2>

            <div class="grid">
                <div class="form-group">
                    <label>Default Selling Price (‚Çπ)</label>
                    <input type="number" id="sell" value="1000" step="10" oninput="updatePreview()">
                </div>

                <div class="form-group">
                    <label>Selling Price Includes GST?</label>
                    <select id="sellIncludesGST" onchange="updatePreview()">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üå∫</span> Perfume Oils</h2>

            <div class="alert alert-info">
                <span class="icon">‚ÑπÔ∏è</span>
                <div>
                    <strong>Format:</strong> <code>OilName, AED_per_litre, concentration%, sellingPrice, bottleSize_ml</code><br>
                    <strong>Examples:</strong><br>
                    ‚Ä¢ <code>ArabianRose, 600, 25</code> - Uses default price (‚Çπ1000) and size (50ml)<br>
                    ‚Ä¢ <code>ArabianRose, 600, 25, 1200</code> - Custom selling price ‚Çπ1200 for 50ml<br>
                    ‚Ä¢ <code>ArabianRose, 600, 25, 1200, 100</code> - Custom price ‚Çπ1200 for 100ml bottle<br>
                    ‚Ä¢ <code>ArabianRose, 600</code> - Uses default concentrations, price & bottle size
                </div>
            </div>

            <div class="form-group">
                <label>Oil List <span class="label-info">(one per line)</span></label>
                <textarea id="oils" oninput="updatePreview()">Oud maracuja, 700, 30, 1000, 50
dior suvage, 450, 25, 600, 100
ArabianRose, 600, 25
LuxuryOud, 1500, 30</textarea>
            </div>

            <h3>Default Concentrations</h3>
            <p style="color: #666; margin-bottom: 10px; font-size: 0.9em;">
                If no concentration is specified for an oil, these concentrations will be calculated:
            </p>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                <div class="form-group">
                    <label>Conc 1 (%)</label>
                    <input type="number" id="conc1" value="30" min="15" max="30" step="5" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Conc 2 (%)</label>
                    <input type="number" id="conc2" value="25" min="15" max="30" step="5" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Conc 3 (%)</label>
                    <input type="number" id="conc3" value="20" min="15" max="30" step="5" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Conc 4 (%)</label>
                    <input type="number" id="conc4" value="15" min="15" max="30" step="5" oninput="updatePreview()">
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üìä</span> Live Preview</h2>
            <div class="table-container">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>Oil Name</th>
                            <th>Size (ml)</th>
                            <th>Conc %</th>
                            <th>Oil ml</th>
                            <th>AED/L</th>
                            <th>Oil Cost (‚Çπ)</th>
                            <th>BCD (‚Çπ)</th>
                            <th>SWS (‚Çπ)</th>
                            <th>Total Cost (‚Çπ)</th>
                            <th>Selling (‚Çπ)</th>
                            <th>Profit (‚Çπ)</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                        <tr>
                            <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
                                Add oils above to see calculations...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <button class="btn btn-primary" style="width: 100%;" onclick="generateExcel()">
                <span class="icon">üì•</span> Download Excel Report (.xlsx)
            </button>
            <div id="status"></div>
        </div>
    </div>

    <script>
        /* Helper functions */
        function safeNum(v, def = 0) {
            v = ('' + v).trim();
            if (v === '') return def;
            var n = Number(v.replace(/,/g, ''));
            return isNaN(n) ? def : n;
        }

        function round(v, d = 2) {
            if (typeof v !== 'number') v = Number(v) || 0;
            const m = Math.pow(10, d);
            return Math.round(v * m) / m;
        }

        /* Get default concentrations from inputs */
        function getDefaultConcentrations() {
            return [
                safeNum(document.getElementById('conc1').value, 30),
                safeNum(document.getElementById('conc2').value, 25),
                safeNum(document.getElementById('conc3').value, 20),
                safeNum(document.getElementById('conc4').value, 15)
            ].filter(c => c > 0);
        }

        /* Parse textarea lines into {name, aed, conc?, sellingPrice?, bottleSize?} */
        function parseOils(text) {
            const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const parsed = [];
            for (let line of lines) {
                let parts = line.split(/[,;\t]/).map(p => p.trim()).filter(Boolean);
                if (parts.length < 2) continue;
                const name = parts[0];
                const aed = safeNum(parts[1], 0);
                const conc = (parts.length >= 3) ? safeNum(parts[2], 0) : 0;
                const sellingPrice = (parts.length >= 4) ? safeNum(parts[3], 0) : 0;
                const bottleSize = (parts.length >= 5) ? safeNum(parts[4], 0) : 0;
                parsed.push({ 
                    name: name, 
                    aed: aed, 
                    conc: conc,
                    sellingPrice: sellingPrice,
                    bottleSize: bottleSize
                });
            }
            return parsed;
        }

        /* Get all inputs */
        function getInputs() {
            return {
                rate: safeNum(document.getElementById('rate').value, 22.6),
                vat: safeNum(document.getElementById('vat').value, 5),
                customs: safeNum(document.getElementById('customs').value, 20),
                sws: safeNum(document.getElementById('sws').value, 10),
                gst: safeNum(document.getElementById('gst').value, 18),
                cif: document.getElementById('cif').value === 'yes',
                bottle: safeNum(document.getElementById('bottle').value, 70),
                labels: safeNum(document.getElementById('labels').value, 10),
                pack: safeNum(document.getElementById('pack').value, 20),
                ship: safeNum(document.getElementById('ship').value, 30),
                sell: safeNum(document.getElementById('sell').value, 1000),
                sellIncludesGST: document.getElementById('sellIncludesGST').value === 'yes'
            };
        }

        /* Build calculation rows */
        function buildRows(oilsParsed, inputs) {
            const rows = [];
            const rate = inputs.rate;
            const vatPct = inputs.vat / 100;
            const customsPct = inputs.customs / 100;
            const swsPct = inputs.sws / 100;
            const gstPct = inputs.gst / 100;
            const defaultBottle = inputs.bottle;
            const labels = inputs.labels;
            const pack = inputs.pack;
            const ship = inputs.ship;
            const defaultSellingPrice = inputs.sell;
            const sellIncludesGST = inputs.sellIncludesGST;
            const cif = inputs.cif;
            const defaultBottleSize = 50; // Default 50ml

            const defaultConcs = getDefaultConcentrations();

            oilsParsed.forEach(item => {
                const concs = (item.conc && item.conc > 0) ? [item.conc] : defaultConcs;
                concs.forEach(conc => {
                    // Use custom selling price if provided, otherwise use default
                    const sellingPrice = (item.sellingPrice && item.sellingPrice > 0) ? item.sellingPrice : defaultSellingPrice;
                    // Use custom bottle size if provided, otherwise use default 50ml
                    const bottleSize = (item.bottleSize && item.bottleSize > 0) ? item.bottleSize : defaultBottleSize;
                    
                    // Calculate size ratio for scaling costs
                    const sizeRatio = bottleSize / 50.0;
                    
                    // Scale bottle, labels, pack, and ship costs based on bottle size
                    const bottle = defaultBottle * sizeRatio;
                    const labelsScaled = labels * sizeRatio;
                    const packScaled = pack * sizeRatio;
                    const shipScaled = ship * sizeRatio;
                    
                    const netSellingPrice = sellIncludesGST ? (sellingPrice / (1 + gstPct)) : sellingPrice;
                    const gstAmountTop = sellIncludesGST ? (sellingPrice - netSellingPrice) : (netSellingPrice * gstPct);

                    const oilMl = bottleSize * (conc / 100.0);
                    const oilLitres = oilMl / 1000.0;
                    const priceAED_perL = item.aed;
                    const priceAED_used = priceAED_perL * oilLitres;
                    const priceINR = priceAED_used * rate;
                    const dubaiVAT = priceINR * vatPct;
                    const landedOil = priceINR + dubaiVAT;
                    const customsBase = cif ? (landedOil + shipScaled) : landedOil;
                    const customsDuty = customsBase * customsPct;
                    const swsAmount = customsDuty * swsPct;
                    const totalBeforeGST = landedOil + customsDuty + swsAmount + bottle + labelsScaled + packScaled + shipScaled;
                    const gstAmount = sellIncludesGST ? gstAmountTop : (netSellingPrice * gstPct);
                    const totalInclGST = totalBeforeGST + gstAmount;
                    const profitExcl = netSellingPrice - totalBeforeGST;
                    const profitIncl = sellingPrice - totalInclGST;
                    const marginPct = netSellingPrice ? (profitExcl / netSellingPrice * 100) : 0;

                    rows.push({
                        "Oil Name": item.name,
                        "Bottle Size (ml)": bottleSize,
                        "Concentration %": conc,
                        "Oil ml used": round(oilMl, 3),
                        "AED per L": round(priceAED_perL, 2),
                        "AED for used oil": round(priceAED_used, 3),
                        "Price INR (oil qty)": round(priceINR, 2),
                        "Dubai VAT (INR)": round(dubaiVAT, 2),
                        "Landed oil (INR)": round(landedOil, 2),
                        "Customs base (INR)": round(customsBase, 2),
                        "Customs duty (INR)": round(customsDuty, 2),
                        "SWS (INR)": round(swsAmount, 2),
                        "Bottle (‚Çπ)": round(bottle, 2),
                        "Labels (‚Çπ)": round(labelsScaled, 2),
                        "Packaging (‚Çπ)": round(packScaled, 2),
                        "Shipping (‚Çπ)": round(shipScaled, 2),
                        "Total before GST (‚Çπ)": round(totalBeforeGST, 2),
                        "Net selling price (‚Çπ)": round(netSellingPrice, 2),
                        "GST amount (‚Çπ)": round(gstAmount, 2),
                        "Total incl GST (‚Çπ)": round(totalInclGST, 2),
                        "Selling price (‚Çπ)": sellingPrice,
                        "Profit excl GST (‚Çπ)": round(profitExcl, 2),
                        "Profit incl GST (‚Çπ)": round(profitIncl, 2),
                        "Profit margin (%)": round(marginPct, 2)
                    });
                });
            });

            return rows;
        }

        /* Update live preview table */
        function updatePreview() {
            const rawText = document.getElementById('oils').value;
            const parsed = parseOils(rawText);
            const inputs = getInputs();

            if (parsed.length === 0) {
                document.getElementById('previewBody').innerHTML = `
      <tr>
        <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
          Add oils above to see calculations...
        </td>
      </tr>
    `;
                return;
            }

            const rows = buildRows(parsed, inputs);
            let html = '';

            rows.forEach(row => {
                const profitClass = row["Profit margin (%)"] >= 30 ? 'profit-positive' :
                    row["Profit margin (%)"] >= 15 ? 'profit-neutral' : 'profit-negative';

                html += `
      <tr>
        <td><strong>${row["Oil Name"]}</strong></td>
        <td>${row["Bottle Size (ml)"]}ml</td>
        <td>${row["Concentration %"]}%</td>
        <td>${row["Oil ml used"]}</td>
        <td>AED ${row["AED per L"]}</td>
        <td>‚Çπ${row["Price INR (oil qty)"]}</td>
        <td>‚Çπ${row["Customs duty (INR)"]}</td>
        <td>‚Çπ${row["SWS (INR)"]}</td>
        <td><strong>‚Çπ${row["Total incl GST (‚Çπ)"]}</strong></td>
        <td>‚Çπ${row["Selling price (‚Çπ)"]}</td>
        <td class="${profitClass}">‚Çπ${row["Profit incl GST (‚Çπ)"]}</td>
        <td class="${profitClass}">${row["Profit margin (%)"]}%</td>
      </tr>
    `;
            });

            document.getElementById('previewBody').innerHTML = html;
        }

        /* Generate and download Excel */
        function generateExcel() {
            const status = document.getElementById('status');
            status.className = 'status';
            status.textContent = 'Parsing inputs...';

            const inputs = getInputs();
            const rawText = document.getElementById('oils').value;
            const parsed = parseOils(rawText);

            if (parsed.length === 0) {
                status.className = 'status error';
                status.textContent = 'No valid oil lines found. Use "Name, AED_per_litre" per line.';
                return;
            }

            status.textContent = 'Building P&L rows...';
            const rows = buildRows(parsed, inputs);

            status.textContent = 'Generating Excel...';
            try {
                downloadXLSX(rows, inputs);
                status.className = 'status success';
                status.textContent = '‚úì Excel file downloaded successfully!';
                setTimeout(() => { status.textContent = ''; }, 3000);
            } catch (err) {
                console.error(err);
                status.className = 'status error';
                status.textContent = 'Error generating file: ' + (err.message || err);
            }
        }

        /* Create and download XLSX using SheetJS */
        function downloadXLSX(rows, inputs) {
            const headers = [
                "Oil Name", "Bottle Size (ml)", "Concentration %", "Oil ml used", "AED per L", "AED for used oil", "Price INR (oil qty)", "Dubai VAT (INR)",
                "Landed oil (INR)", "Customs base (INR)", "Customs duty (INR)", "SWS (INR)", "Bottle (‚Çπ)", "Labels (‚Çπ)", "Packaging (‚Çπ)", "Shipping (‚Çπ)",
                "Total before GST (‚Çπ)", "Net selling price (‚Çπ)", "GST amount (‚Çπ)", "Total incl GST (‚Çπ)", "Selling price (‚Çπ)",
                "Profit excl GST (‚Çπ)", "Profit incl GST (‚Çπ)", "Profit margin (%)"
            ];

            const aoa = [headers];
            rows.forEach(r => {
                aoa.push(headers.map(h => r[h]));
            });

            const defaultConcs = getDefaultConcentrations();
            const inputsSheet = [
                ["AED‚ÜíINR rate", inputs.rate],
                ["Dubai VAT %", inputs.vat],
                ["Basic Customs Duty (BCD) %", inputs.customs],
                ["Social Welfare Surcharge (SWS) %", inputs.sws],
                ["GST %", inputs.gst],
                ["Apply BCD on shipping (CIF)?", inputs.cif ? "Yes" : "No"],
                ["Bottle (‚Çπ)", inputs.bottle],
                ["Labels (‚Çπ)", inputs.labels],
                ["Packaging (‚Çπ)", inputs.pack],
                ["Shipping (‚Çπ)", inputs.ship],
                ["Default selling price (‚Çπ)", inputs.sell],
                ["Selling price includes GST?", inputs.sellIncludesGST ? "Yes" : "No"],
                ["Auto concentrations used (if not overridden per-line)", defaultConcs.join(", ") + "%"]
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            XLSX.utils.book_append_sheet(wb, ws, "Comparison");
            const ws2 = XLSX.utils.aoa_to_sheet(inputsSheet);
            XLSX.utils.book_append_sheet(wb, ws2, "Inputs");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const filename = 'perfume_pnl_comparison_2025.xlsx';

            if (navigator.msSaveOrOpenBlob) {
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
            }
        }

        // Initialize preview on page load
        document.addEventListener('DOMContentLoaded', function () {
            updatePreview();
        });
    </script>
</body>

</html>